name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Unit & Source Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Make scripts executable
        run: |
          chmod +x tiles/intent-integrity-kit/skills/iikit-core/scripts/bash/*.sh
          chmod +x tests/*.sh

      - name: Run BATS unit tests
        run: tests/run-tests.sh

      - name: Run source validation tests
        run: tests/run-source-tests.sh

  publish:
    name: Publish & Verify
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if tile version changed
        id: version
        run: |
          NEW=$(jq -r .version tiles/intent-integrity-kit/tile.json)
          # Compare against latest release tag to handle multi-commit pushes
          LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -1 | sed 's/^v//')
          OLD=${LATEST_TAG:-""}
          echo "old=$OLD" >> "$GITHUB_OUTPUT"
          echo "new=$NEW" >> "$GITHUB_OUTPUT"
          if [[ -z "$OLD" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "No previous tag found, publishing $NEW"
          elif [[ "$NEW" != "$OLD" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Version changed: $OLD → $NEW"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "Version unchanged ($NEW), skipping publish"
          fi

      - name: Resolve symlinks in tile directory
        if: steps.version.outputs.changed == 'true'
        run: |
          # Replace symlinks with real copies so the archive contains real files
          cd tiles/intent-integrity-kit
          # Resolve directory symlinks first (e.g., skills -> ../../.claude/skills)
          find . -maxdepth 3 -type l | while read link; do
            target=$(readlink -f "$link")
            if [ -d "$target" ]; then
              rm "$link"
              cp -R "$target" "$link"
              echo "Resolved dir symlink: $link"
            elif [ -f "$target" ]; then
              rm "$link"
              cp "$target" "$link"
              echo "Resolved file symlink: $link"
            fi
          done

      - name: Make skills self-contained
        if: steps.version.outputs.changed == 'true'
        run: |
          cd tiles/intent-integrity-kit/skills
          for skill_dir in iikit-*/; do
            [ "$skill_dir" = "iikit-core/" ] && continue
            skill_md="$skill_dir/SKILL.md"
            [ ! -f "$skill_md" ] && continue

            # Copy referenced files from iikit-core into this skill
            for subdir in references templates; do
              if grep -q "../iikit-core/$subdir/" "$skill_md"; then
                mkdir -p "$skill_dir/$subdir"
                # Copy only files actually referenced
                grep -oP "(?<=\.\./iikit-core/$subdir/)[a-z-]+\.md" "$skill_md" | sort -u | while read file; do
                  if [ -f "iikit-core/$subdir/$file" ]; then
                    cp "iikit-core/$subdir/$file" "$skill_dir/$subdir/$file"
                    echo "  Copied $subdir/$file → $skill_dir$subdir/"
                  fi
                done
                # Rewrite links: ../iikit-core/subdir/file.md → ./subdir/file.md
                sed -i "s|\.\./iikit-core/$subdir/|./$subdir/|g" "$skill_md"
              fi
            done
            echo "✓ $skill_dir is self-contained"
          done

          # Clean up iikit-core: references/ fully distributed, remove to avoid orphans
          rm -rf iikit-core/references
          echo "✓ Removed iikit-core/references/ (fully distributed)"

          # Remove templates only referenced from SKILL.md (now distributed as local copies)
          # Keep templates referenced by scripts: agent-file-template.md, spec-template.md, plan-template.md
          for tmpl in constitution-template.md checklist-template.md tasks-template.md testspec-template.md; do
            rm -f "iikit-core/templates/$tmpl"
          done
          echo "✓ Removed distributed-only templates from iikit-core/templates/"

      - name: Sync SKILL.md versions to tile version
        if: steps.version.outputs.changed == 'true'
        run: |
          VERSION=${{ steps.version.outputs.new }}
          for skill in tiles/intent-integrity-kit/skills/*/SKILL.md; do
            if grep -q 'version:' "$skill"; then
              sed -i "s/version: \".*\"/version: \"$VERSION\"/" "$skill"
              echo "Synced $skill to $VERSION"
            fi
          done

      - name: Publish tile v${{ steps.version.outputs.new }}
        if: steps.version.outputs.changed == 'true'
        uses: tesslio/publish@main
        with:
          token: ${{ secrets.TESSL_TOKEN }}
          path: tiles/intent-integrity-kit

      - uses: actions/setup-node@v4
        if: steps.version.outputs.changed == 'true'
        with:
          node-version: '20'

      - name: Install tessl CLI (for e2e verification)
        if: steps.version.outputs.changed == 'true'
        run: npm install -g @tessl/cli

      - name: Make scripts executable
        if: steps.version.outputs.changed == 'true'
        run: |
          chmod +x tiles/intent-integrity-kit/skills/iikit-core/scripts/bash/*.sh
          chmod +x tests/*.sh

      - name: Verify tile (install from registry + e2e tests)
        if: steps.version.outputs.changed == 'true'
        run: tests/run-tile-tests.sh --from-registry

      - name: Tag release
        if: steps.version.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "v${{ steps.version.outputs.new }}"
          git push --tags
